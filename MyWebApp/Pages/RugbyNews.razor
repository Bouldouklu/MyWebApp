@page "/rugby"
@using MyWebApp.Services

<PageTitle>International Rugby News</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üèâ International Rugby News</h1>
    <button class="btn btn-outline-primary" @onclick="RefreshNews" disabled="@loadingNews">
        @if (loadingNews)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
        }
        else
        {
            <span>üîÑ</span>
        }
        Refresh
    </button>
</div>

<div class="alert alert-info mb-4">
    <h6 class="alert-heading">üåç International Rugby Focus</h6>
    <p class="mb-0">Cette page affiche uniquement les actualit√©s du rugby international : Six Nations, Rugby Championship, Coupe du Monde, XV de France, et matchs internationaux.</p>
</div>

@if (rugbyArticles?.Any() == true)
{
    <div class="row">
        @foreach (var article in rugbyArticles)
        {
            <div class="col-xl-3 col-lg-4 col-md-6 col-sm-6 mb-4">
                <div class="card h-100 shadow-sm">
                    @if (!string.IsNullOrEmpty(article.Thumbnail))
                    {
                        <img src="@article.Thumbnail" 
                             class="card-img-top" 
                             alt="@article.Title" 
                             style="height: 200px; object-fit: cover;" />
                    }
                    else
                    {
                        <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                            <span class="text-muted display-4">üèâ</span>
                        </div>
                    }
                    
                    <div class="card-body d-flex flex-column">
                        <!-- Category Badge -->
                        <div class="mb-2">
                            <span class="badge bg-success">
                                @RugbyNewsService.GetCategoryIcon(article.Category) @article.Category
                            </span>
                        </div>
                        
                        <h5 class="card-title">
                            <a href="@article.Link" target="_blank" class="text-decoration-none">
                                @article.Title
                            </a>
                        </h5>
                        
                        <p class="card-text text-muted small flex-grow-1">
                            @article.Description
                        </p>
                        
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    üìÖ @RugbyNewsService.GetTimeAgo(article.PublishDate)
                                </small>
                                <small class="text-muted">
                                    üì∞ @article.Source
                                </small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-transparent border-0">
                        <a href="@article.Link" target="_blank" class="btn btn-success btn-sm w-100">
                            Lire l'article ‚Üí
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
    
    <!-- Load More Button -->
    <div class="text-center mt-4">
        <button class="btn btn-outline-secondary" @onclick="LoadMoreArticles" disabled="@loadingMore">
            @if (loadingMore)
            {
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                <text>Chargement</text>
            }
            else
            {
                <text>Charger plus d'articles</text>
            }
        </button>
    </div>
    
    <!-- Rugby Statistics -->
    <div class="row mt-5">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">üìä Articles charg√©s</h5>
                    <p class="card-text display-6">@rugbyArticles.Count</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">üìà Dernier article</h5>
                    <p class="card-text">
                        @if (rugbyArticles.Any())
                        {
                            @RugbyNewsService.GetTimeAgo(rugbyArticles.OrderByDescending(a => a.PublishDate).First().PublishDate)
                        }
                        else
                        {
                            <span>Aucun article</span>
                        }
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">üá´üá∑ XV de France</h5>
                    <p class="card-text display-6">@rugbyArticles.Count(a => a.Category.ToLower().Contains("xv de france") || a.Category.ToLower().Contains("france"))</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">üèÜ Comp√©titions</h5>
                    <p class="card-text display-6">@rugbyArticles.Where(a => a.Category.ToLower().Contains("championship") || a.Category.ToLower().Contains("six nations")).Count()</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Categories Breakdown -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>üè∑Ô∏è Cat√©gories d'articles</h5>
                </div>
                <div class="card-body">
                    @{
                        var topCategories = rugbyArticles
                            .Where(a => !string.IsNullOrEmpty(a.Category))
                            .GroupBy(a => a.Category)
                            .OrderByDescending(g => g.Count())
                            .Take(8)
                            .ToList();
                    }
                    
                    @if (topCategories.Any())
                    {
                        <div class="row">
                            @foreach (var categoryGroup in topCategories)
                            {
                                <div class="col-md-3 col-sm-6 mb-2">
                                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                        <span class="fw-bold">
                                            @RugbyNewsService.GetCategoryIcon(categoryGroup.Key) @categoryGroup.Key
                                        </span>
                                        <span class="badge bg-success">@categoryGroup.Count()</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Aucune cat√©gorie disponible</p>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <!-- Competitions Info -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>üèÜ Comp√©titions internationales suivies</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <div class="display-6">üá™üá∫</div>
                                <h6>Six Nations</h6>
                                <small class="text-muted">Tournoi des 6 Nations</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <div class="display-6">üèÜ</div>
                                <h6>Rugby Championship</h6>
                                <small class="text-muted">H√©misph√®re Sud</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <div class="display-6">üåç</div>
                                <h6>Coupe du Monde</h6>
                                <small class="text-muted">Comp√©tition mondiale</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6 mb-3">
                            <div class="text-center">
                                <div class="display-6">üá´üá∑</div>
                                <h6>XV de France</h6>
                                <small class="text-muted">√âquipe nationale</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else if (loadingNews)
{
    <div class="text-center my-5">
        <div class="spinner-border mb-3" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4>Chargement des actualit√©s rugby...</h4>
        <p class="text-muted">R√©cup√©ration des derniers articles de rugby international depuis Rugbyrama</p>
        
        <div class="card mt-4">
            <div class="card-body">
                <h6>üîç Filtrage en cours...</h6>
                <p class="small text-muted">
                    Seuls les articles de rugby international sont affich√©s :<br>
                    Six Nations, Rugby Championship, Coupe du Monde, XV de France, matchs internationaux
                </p>
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center my-5">
        <div class="alert alert-warning">
            <h4>üèâ Impossible de charger les actualit√©s rugby</h4>
            <p>Nous n'avons pas pu r√©cup√©rer les derniers articles de Rugbyrama. Cela peut √™tre d√ª √† :</p>
            <ul class="text-start">
                <li>Probl√®mes de connexion internet</li>
                <li>Flux RSS de Rugbyrama temporairement indisponible</li>
                <li>Limites du service proxy CORS</li>
                <li>Changements dans le format du flux RSS</li>
            </ul>
            <button class="btn btn-primary mt-3" @onclick="RefreshNews">
                üîÑ R√©essayer
            </button>
        </div>
        
        <!-- Fallback Content -->
        <div class="card mt-4">
            <div class="card-body">
                <h5>üèâ √Ä propos de Rugbyrama</h5>
                <p class="text-muted">
                    Rugbyrama est le site de r√©f√©rence pour l'actualit√© du rugby fran√ßais et international. 
                    Il couvre toutes les comp√©titions majeures : Top 14, Pro D2, Champions Cup, Six Nations, 
                    Rugby Championship, Coupe du Monde et l'√©quipe de France.
                </p>
                <a href="https://www.rugbyrama.fr/" target="_blank" class="btn btn-outline-success">
                    Visiter Rugbyrama.fr ‚Üí
                </a>
            </div>
        </div>
    </div>
}

@code {
    [Inject] public RugbyNewsService RugbyNewsService { get; set; } = default!;
    
    private List<RugbyArticle> rugbyArticles = new();
    private bool loadingNews = true;
    private bool loadingMore = false;
    private int articlesPerLoad = 20;
    private int currentArticlesLoaded = 20;

    protected override async Task OnInitializedAsync()
    {
        await LoadRugbyNews();
    }

    private async Task LoadRugbyNews()
    {
        loadingNews = true;
        StateHasChanged();
        
        try
        {
            Console.WriteLine("Starting to load international rugby news...");
            var articles = await RugbyNewsService.GetInternationalRugbyNewsAsync(currentArticlesLoaded);
            Console.WriteLine($"Received {articles?.Count ?? 0} international rugby articles");
            
            if (articles != null)
            {
                rugbyArticles = articles;
                Console.WriteLine("International rugby news loaded successfully");
            }
            else
            {
                Console.WriteLine("Rugby articles was null");
                rugbyArticles = new List<RugbyArticle>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading rugby news: {ex.Message}");
            rugbyArticles = new List<RugbyArticle>();
        }
        finally
        {
            loadingNews = false;
            StateHasChanged();
        }
    }

    private async Task RefreshNews()
    {
        currentArticlesLoaded = articlesPerLoad;
        await LoadRugbyNews();
    }

    private async Task LoadMoreArticles()
    {
        loadingMore = true;
        StateHasChanged();
        
        currentArticlesLoaded += articlesPerLoad;
        
        try
        {
            var articles = await RugbyNewsService.GetInternationalRugbyNewsAsync(currentArticlesLoaded);
            if (articles != null)
            {
                rugbyArticles = articles;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading more rugby articles: {ex.Message}");
        }
        finally
        {
            loadingMore = false;
            StateHasChanged();
        }
    }
}